from androguard.misc import AnalyzeAPK
import glob


def read_log(CLS):
    logr = open(r"log%s.txt"%(CLS),mode = "r")
    log = logr.read()
    flist = log.split('!!break!!')
    flist.remove('')
    logr.close()
    return flist

def write_log(CLS, filename):
    logw = open(r"log{}.txt".format(CLS),mode = "a")
    logw.write(filename+"!!break!!")
    logw.close()
    return

def loadApp(dir, cls):
    files = glob.glob(dir)
    files = sorted(files)
    done = read_log(cls)
    count = 0
    print("\nSearching folder ",dir)
    if set(files).issubset(set(done)):
        print("\nNo new files to extract")
        return
    for f in files:
        done = read_log(cls)
        if f in done:
            continue
        print("\n\nOpening file ",f)
        try:
            a, d, dx = AnalyzeAPK(f)
            name = a.get_package()
        except:
            print("\nError opening ",f)
            done.append(f)
            continue
        yield (name, a, d, dx)
        print(name, "extracted successfully...")
        print("\n\n", len(done) + 1, "files extracted. \n\n")
        write_log(cls, f)
