import boto3
import botocore
import paramiko
import glob
from scp import SCPClient

KEY = paramiko.RSAKey.from_private_key_file(r"C:\Users\user\Desktop\MalKey.pem")
URL = "ec2-13-235-128-119.ap-south-1.compute.amazonaws.com"
DEST = r"/home/ec2-user/apps/"
USER = "ec2-user"
DIR = r"apps\*.apk"

client = paramiko.SSHClient()
client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
client.connect(hostname = URL, username = USER, pkey = KEY, port = 22)
scp = SCPClient(client.get_transport())
file = glob.glob(DIR)[0]
name = file.split("apps\\")[1]

scp.put(file, remote_path = DEST)
stdin, stdout, stder = client.exec_command("docker cp /home/ec2-user/apps/{} malDetCont:/deploy/").format(name)
dat = {'file_name': name}
resp = requests.post("http://{}:80/predict".format(URL), json = dat )
if resp.status_code == 200:
    val = resp.json()
    print("File name\t", val['fileName'])
    print("App name\t", val['appName'])
    print("Number of requested permissions\t", val['permCount'])
    print("Number of external API calls made\t", val['classCount'])
    if val['class'] == 'M':
        print("Malware")
    else:
        print("Safe")
else:
    print("Error", resp.status_code)
